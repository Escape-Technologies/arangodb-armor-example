'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var graphqlArmorBlockFieldSuggestions = require('@escape.tech/graphql-armor-block-field-suggestions');
var graphqlArmorCharacterLimit = require('@escape.tech/graphql-armor-character-limit');
var graphql = require('graphql');
var graphqlArmorCostLimit = require('@escape.tech/graphql-armor-cost-limit');
var graphqlArmorMaxAliases = require('@escape.tech/graphql-armor-max-aliases');
var graphqlArmorMaxDepth = require('@escape.tech/graphql-armor-max-depth');
var graphqlArmorMaxDirectives = require('@escape.tech/graphql-armor-max-directives');

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }

  return obj;
}

class ApolloProtection {
  constructor(config) {
    _defineProperty(this, "config", void 0);

    _defineProperty(this, "enabledByDefault", true);

    this.config = config;
  }

}

const plugin$1 = ({
  mask
}) => {
  return {
    async requestDidStart() {
      return {
        async didEncounterErrors({
          errors
        }) {
          for (const error of errors) {
            error.message = error.message.replace(/Did you mean ".+"/g, mask);
          }
        }

      };
    }

  };
};

class ApolloBlockFieldSuggestionProtection extends ApolloProtection {
  get isEnabled() {
    if (!this.config.blockFieldSuggestion) {
      return this.enabledByDefault;
    }

    return this.config.blockFieldSuggestion.enabled ?? this.enabledByDefault;
  }

  protect() {
    return {
      plugins: [plugin$1(this.config.blockFieldSuggestion ?? graphqlArmorBlockFieldSuggestions.blockFieldSuggestionsDefaultOptions)]
    };
  }

}

const plugin = ({
  maxLength
}) => {
  return {
    async requestDidStart(context) {
      if (!context.request.query) return;

      if (context.request.query.length > maxLength) {
        throw new graphql.GraphQLError('Query is too large.', {
          extensions: {
            code: 'BAD_USER_INPUT'
          }
        });
      }
    }

  };
};

class ApolloCharacterLimitProtection extends ApolloProtection {
  get isEnabled() {
    if (!this.config.characterLimit) {
      return this.enabledByDefault;
    }

    return this.config.characterLimit.enabled ?? this.enabledByDefault;
  }

  protect() {
    var _this$config$characte;

    return {
      plugins: [plugin({
        maxLength: ((_this$config$characte = this.config.characterLimit) === null || _this$config$characte === void 0 ? void 0 : _this$config$characte.maxLength) ?? graphqlArmorCharacterLimit.characterLimitDefaultOptions.maxLength
      })]
    };
  }

}

class ApolloCostLimitProtection extends ApolloProtection {
  get isEnabled() {
    if (!this.config.costLimit) {
      return this.enabledByDefault;
    }

    return this.config.costLimit.enabled ?? this.enabledByDefault;
  }

  protect() {
    return {
      validationRules: [graphqlArmorCostLimit.costLimitRule(message => {
        throw new graphql.GraphQLError(message, {
          extensions: {
            code: 'BAD_USER_INPUT'
          }
        });
      }, this.config.costLimit)]
    };
  }

}

class ApolloMaxAliasesProtection extends ApolloProtection {
  get isEnabled() {
    if (!this.config.maxAliases) {
      return this.enabledByDefault;
    }

    return this.config.maxAliases.enabled ?? this.enabledByDefault;
  }

  protect() {
    return {
      validationRules: [graphqlArmorMaxAliases.maxAliasesRule(message => {
        throw new graphql.GraphQLError(message, {
          extensions: {
            code: 'BAD_USER_INPUT'
          }
        });
      }, this.config.maxAliases)]
    };
  }

}

class ApolloMaxDepthProtection extends ApolloProtection {
  get isEnabled() {
    if (!this.config.maxDepth) {
      return this.enabledByDefault;
    }

    return this.config.maxDepth.enabled ?? this.enabledByDefault;
  }

  protect() {
    return {
      validationRules: [graphqlArmorMaxDepth.maxDepthRule(message => {
        throw new graphql.GraphQLError(message, {
          extensions: {
            code: 'BAD_USER_INPUT'
          }
        });
      }, this.config.maxDepth)]
    };
  }

}

class ApolloMaxDirectivesProtection extends ApolloProtection {
  get isEnabled() {
    if (!this.config.maxDirectives) {
      return this.enabledByDefault;
    }

    return this.config.maxDirectives.enabled ?? this.enabledByDefault;
  }

  protect() {
    return {
      validationRules: [graphqlArmorMaxDirectives.maxDirectivesRule(message => {
        throw new graphql.GraphQLError(message, {
          extensions: {
            code: 'BAD_USER_INPUT'
          }
        });
      }, this.config.maxDirectives)]
    };
  }

}

class ApolloArmor {
  constructor(config = {}) {
    _defineProperty(this, "protections", void 0);

    this.protections = [new ApolloBlockFieldSuggestionProtection(config), new ApolloCharacterLimitProtection(config), new ApolloCostLimitProtection(config), new ApolloMaxAliasesProtection(config), new ApolloMaxDirectivesProtection(config), new ApolloMaxDepthProtection(config)];
  }

  protect() {
    let plugins = [];
    let validationRules = [];

    for (const protection of this.protections) {
      if (protection.isEnabled) {
        const {
          plugins: newPlugins,
          validationRules: newValidationRules
        } = protection.protect();
        plugins = [...plugins, ...(newPlugins || [])];
        validationRules = [...validationRules, ...(newValidationRules || [])];
      }
    }

    return {
      plugins,
      validationRules,
      allowBatchedHttpRequests: false,
      debug: false
    };
  }

}

class EnvelopProtection {
  constructor(config) {
    _defineProperty(this, "config", void 0);

    _defineProperty(this, "enabledByDefault", true);

    this.config = config;
  }

}

class EnvelopBlockFieldSuggestionProtection extends EnvelopProtection {
  get isEnabled() {
    if (!this.config.blockFieldSuggestion) {
      return this.enabledByDefault;
    }

    return this.config.blockFieldSuggestion.enabled ?? this.enabledByDefault;
  }

  protect() {
    return {
      plugins: [graphqlArmorBlockFieldSuggestions.blockFieldSuggestionsPlugin(this.config.blockFieldSuggestion)]
    };
  }

}

class EnvelopCharacterLimitProtection extends EnvelopProtection {
  get isEnabled() {
    if (!this.config.characterLimit) {
      return this.enabledByDefault;
    }

    return this.config.characterLimit.enabled ?? this.enabledByDefault;
  }

  protect() {
    return {
      plugins: [graphqlArmorCharacterLimit.characterLimitPlugin(this.config.characterLimit)]
    };
  }

}

class EnvelopCostLimitProtection extends EnvelopProtection {
  get isEnabled() {
    if (!this.config.costLimit) {
      return this.enabledByDefault;
    }

    return this.config.costLimit.enabled ?? this.enabledByDefault;
  }

  protect() {
    return {
      plugins: [graphqlArmorCostLimit.costLimitPlugin(this.config.costLimit)]
    };
  }

}

class EnvelopMaxAliasesProtection extends EnvelopProtection {
  get isEnabled() {
    if (!this.config.maxAliases) {
      return this.enabledByDefault;
    }

    return this.config.maxAliases.enabled ?? this.enabledByDefault;
  }

  protect() {
    return {
      plugins: [graphqlArmorMaxAliases.maxAliasesPlugin(this.config.maxAliases)]
    };
  }

}

class EnvelopMaxDepthProtection extends EnvelopProtection {
  get isEnabled() {
    if (!this.config.maxDepth) {
      return this.enabledByDefault;
    }

    return this.config.maxDepth.enabled ?? this.enabledByDefault;
  }

  protect() {
    return {
      plugins: [graphqlArmorMaxDepth.maxDepthPlugin(this.config.maxDepth)]
    };
  }

}

class EnvelopMaxDirectivesProtection extends EnvelopProtection {
  get isEnabled() {
    if (!this.config.maxDirectives) {
      return this.enabledByDefault;
    }

    return this.config.maxDirectives.enabled ?? this.enabledByDefault;
  }

  protect() {
    return {
      plugins: [graphqlArmorMaxDirectives.maxDirectivesPlugin(this.config.maxDirectives)]
    };
  }

}

const EnvelopArmorPlugin = config => {
  const armor = new EnvelopArmor(config);
  const enhancements = armor.protect();
  return {
    onPluginInit({
      addPlugin
    }) {
      for (const plugin of enhancements.plugins) {
        addPlugin(plugin);
      }
    }

  };
};
class EnvelopArmor {
  constructor(config = {}) {
    _defineProperty(this, "protections", void 0);

    this.protections = [new EnvelopBlockFieldSuggestionProtection(config), new EnvelopCharacterLimitProtection(config), new EnvelopMaxDirectivesProtection(config), new EnvelopMaxAliasesProtection(config), new EnvelopCostLimitProtection(config), new EnvelopMaxDepthProtection(config)];
  }

  protect() {
    const plugins = [];

    for (const protection of this.protections) {
      if (protection.isEnabled) {
        const enhancements = protection.protect();
        plugins.push(...enhancements.plugins);
      }
    }

    return {
      plugins
    };
  }

}

exports.ApolloArmor = ApolloArmor;
exports.EnvelopArmor = EnvelopArmor;
exports.EnvelopArmorPlugin = EnvelopArmorPlugin;
